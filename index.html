<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Inspyfold</title>
    <link rel="stylesheet" href="/src/styles.css" />
    <link rel="icon" id="appFavicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22 fill=%22%23d4a5a5%22>âœ´ï¸</text></svg>">
  </head>
  <body>
<div class="app-shell">
    <header class="header">
      <div onclick="location.reload()">
        <img src="logo_l.png" id="mainLogo" class="logo-img" alt="Inspyfold" />
      </div>
      <div class="header-btns">
        <button class="btn-ghost" onclick="handleLockToggle()" id="lockBtn" title="ì ê¸ˆ">ğŸ”“</button>
        <button class="btn-ghost" onclick="openPalette()" id="paletteBtn" title="í…Œë§ˆ ìƒ‰ìƒ">ğŸ¨</button>
        <button class="btn-ghost" onclick="toggleTheme(true)" id="themeBtn" title="ë‹¤í¬/ë¼ì´íŠ¸">ğŸŒ™</button>
      </div>
    </header>

    <div class="calendar-card">
      <div class="cal-header">
        <div class="cal-nav">
          <button class="btn-cal-nav" onclick="changeMonth(-1)">â—€</button>
          <span class="cal-month" id="calMonth"></span>
          <button class="btn-cal-nav" onclick="changeMonth(1)">â–¶</button>
        </div>
        <button style="border:none;background:var(--primary-15);color:var(--primary);font-size:11px;padding:6px 12px;border-radius:50px;font-weight:950;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none"
                onclick="filterDate(null)">ì „ì²´ë³´ê¸°</button>
      </div>

      <div id="calGridContainer"></div>

      <div class="cal-footer">
        ì˜ê°ì˜ âœ´ï¸ ë¶ˆê½ƒì„ ë°íŒ <span id="sparkDayCount">0</span>ì¼ì˜ ê¸°ë¡
        <div id="rangeTextWrap" style="display:none;"></div>
      </div>
    </div>

    <div class="dashboard">
      <div class="stat-card active" id="tabAll" onclick="setFavFilter(false)">
        <span class="stat-num" id="allCount">0</span><br>
        <span style="font-size:12px;color:var(--sub-text);font-weight:850;">Inspirations</span>
      </div>
      <div class="stat-card" id="tabFav" onclick="setFavFilter(true)">
        <span class="stat-num" id="favCount">0</span><br>
        <span style="font-size:12px;color:var(--sub-text);font-weight:850;">Starred</span>
      </div>
    </div>

    <div class="folder-scroll" id="folderList"></div>

    <div class="search-wrap" id="searchWrap">
      <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="ì˜ê°ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." oninput="handleSearchInput()">
        <button class="search-clear" id="searchClearBtn" onclick="clearSearch()" aria-label="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">âœ•</button>
      </div>
    </div>

    <div class="input-card">
      <textarea id="memoInput" placeholder="ì˜¤ëŠ˜ ë‹¹ì‹ ì„ ìŠ¤ì¹œ ìƒê°ì€ ë¬´ì—‡ì¸ê°€ìš”?"></textarea>

      <div id="imgPreviewWrap">
        <div style="position:relative;">
          <img id="imgPreview" alt="ì²¨ë¶€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
          <button type="button" class="img-preview-close" onclick="clearAttachedImage(false)">âœ•</button>
        </div>
        <div style="margin-top:10px; font-size:12px; color:var(--sub-text); font-weight:850; line-height:1.5;">
          ì‚¬ì§„ì€ ìë™ìœ¼ë¡œ ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶•ë˜ì–´ ì €ì¥ë¼ìš”.
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
        <div style="display:flex; gap:8px;">
          <select id="folderSelect"></select>
          <button style="background:var(--bg); border:1px solid var(--border); border-radius:12px; width:42px; height:42px; cursor:pointer; -webkit-tap-highlight-color: transparent; user-select:none;"
                  onclick="document.getElementById('imgInput').click()">ğŸ“·</button>
          <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="previewImage(event)">
        </div>
        <button class="btn-add" id="saveBtn" onclick="addMemo()">ì €ì¥</button>
      </div>
    </div>

    <div id="memoContainer"></div>

    <div class="clock-section">
      <div class="clock-time" id="liveClock">00:00:00</div>
      <div class="clock-text">ì˜ê°ì„ ê¸°ë¡í•  ì‹œê°„ì…ë‹ˆë‹¤.</div>
    </div>

    <div class="backup-btns">
      <button class="btn-backup" onclick="exportData()">âœ´ï¸ ì˜ê° ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn-backup" onclick="document.getElementById('importFile').click()">âœ´ï¸ ì˜ê° ê°€ì ¸ì˜¤ê¸°</button>
      <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
    </div>

    <footer>
      <a href="mailto:starlord@kakao.com" style="color:var(--primary); text-decoration:none; font-size:13px; font-weight:950;">âœ‰ï¸ starlord@kakao.com</a>
      <div style="font-size:11px; color:var(--sub-text); margin-top:10px; opacity:0.7; font-weight:850;">Â© 2026 Inspyfold. All rights reserved.</div>
    </footer>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="modalBackdrop" class="modal-backdrop hidden" onclick="modalOnBackdrop(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">ì œëª©</div>
        <button class="modal-close" onclick="closeModal()" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="modal-desc" id="modalDesc"></div>
        <input class="modal-input" id="modalInput" type="password" autocomplete="off" inputmode="text" />
        <div class="modal-hint" id="modalHint"></div>
        <div id="modalExtra"></div>
      </div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toastWrap"></div>

  <!-- ì´ë¯¸ì§€ ë·°ì–´ -->
  <div id="imgViewer" onclick="closeImageViewer()">
    <div class="viewer-card" onclick="event.stopPropagation()">
      <button class="viewer-close" onclick="closeImageViewer()">âœ•</button>
      <img id="viewerImg" class="viewer-img" alt="ì´ë¯¸ì§€ í™•ëŒ€">
    </div>
  </div>

  <script type="module">
    const DEFAULT_PRIMARY = '#d4a5a5';

    const now = new Date();
    const todayStr = `${now.getFullYear()}. ${now.getMonth() + 1}. ${now.getDate()}.`;

    let memos = JSON.parse(localStorage.getItem('inspy_memos')) || [];
    let folders = JSON.parse(localStorage.getItem('inspy_folders')) || ['ì•„ì´ë””ì–´', 'ì¼ìƒ'];
    let lockPw = localStorage.getItem('inspy_pw') || null;

    let unblurredIds = [];
    let curFolder = 'ì „ì²´';
    let isFavFilter = false;

    let attachedImage = "";
    let attachedImageMeta = { w: 0, h: 0, kb: 0 };

    let currentViewDate = new Date();

    // ë²”ìœ„
    let selectedRange = { start: todayStr, end: todayStr };
    let rangeMode = 'idle';
    let rangeAnchor = null;
    let dragActive = false;

    /* âœ… ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì • ê¸°ë°˜ ì´ˆê¸° í…Œë§ˆ */
    function applyInitialTheme(){
      const stored = localStorage.getItem('inspy_theme'); // 'dark'|'light'|null
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldDark = stored ? (stored === 'dark') : prefersDark;

      document.body.classList.toggle('dark-mode', shouldDark);
      document.getElementById('themeBtn').innerText = shouldDark ? 'â˜€ï¸' : 'ğŸŒ™';
      document.getElementById('mainLogo').src = shouldDark ? 'logo_d.png' : 'logo_l.png';
    }

    function parseDateStr(s){
      const m=(s||'').match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.$/);
      if(!m) return null;
      return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
    }
    function normalizeRange(a,b){
      const da=parseDateStr(a), db=parseDateStr(b);
      if(!da||!db) return null;
      if(da.getTime()<=db.getTime()) return {start:a,end:b};
      return {start:b,end:a};
    }
    function isInRange(dateStr, range){
      if(!range) return true;
      const d=parseDateStr(dateStr), s=parseDateStr(range.start), e=parseDateStr(range.end);
      if(!d||!s||!e) return false;
      const t=d.getTime();
      return t>=s.getTime() && t<=e.getTime();
    }
    function fmtCompact(dateStr){
      const d=parseDateStr(dateStr);
      if(!d) return '';
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${y}.${m}.${dd}`;
    }

    function hexToRgb(hex){
      const h=hex.replace('#','').trim();
      if(h.length!==6) return null;
      return {
        r: parseInt(h.slice(0,2),16),
        g: parseInt(h.slice(2,4),16),
        b: parseInt(h.slice(4,6),16)
      };
    }

    /* âœ… í…Œë§ˆìƒ‰ íŒŒìƒê°’ì„ ì „ë¶€ ë³€ìˆ˜ë¡œë§Œ ê³„ì‚°í•´ì„œ "ì–´ë””ë“ " ìë™ ë°˜ì˜ */
    function setPrimary(hex){
      const rgb = hexToRgb(hex);
      if(!rgb) return;

      const root = document.documentElement.style;
      root.setProperty('--primary', hex);
      root.setProperty('--p-r', rgb.r);
      root.setProperty('--p-g', rgb.g);
      root.setProperty('--p-b', rgb.b);

      localStorage.setItem('inspy_primary', hex);
      updateFavicon(hex);
      render();
    }
    function loadPrimary(){
      const saved = localStorage.getItem('inspy_primary');
      if(saved && /^#[0-9A-Fa-f]{6}$/.test(saved)) setPrimary(saved);
      else setPrimary(DEFAULT_PRIMARY);
    }
    function resetPrimary(){
      localStorage.removeItem('inspy_primary');
      setPrimary(DEFAULT_PRIMARY);
      toast('ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½');
    }
    function updateFavicon(hex){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="85" fill="${hex}">âœ´ï¸</text></svg>`;
      const url = 'data:image/svg+xml,' + encodeURIComponent(svg);
      const el = document.getElementById('appFavicon');
      if(el) el.setAttribute('href', url);
    }

    /* ì‹œê³„ */
    function updateClock(){
      const n = new Date();
      const timeStr = n.toLocaleTimeString('ko-KR', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
      document.getElementById('liveClock').innerText = timeStr;
    }
    setInterval(updateClock,1000); updateClock();

    /* í† ìŠ¤íŠ¸ */
    let toastTimer=null;
    function toast(msg, sub="", duration=1600){
      const wrap=document.getElementById('toastWrap');
      if(!wrap) return;

      if(toastTimer) clearTimeout(toastTimer);
      [...wrap.children].forEach(node=>{ node.classList.add('fadeout'); setTimeout(()=>node.remove(),230); });

      const t=document.createElement('div');
      t.className='toast';
      t.innerHTML = `<div>${msg}</div>${sub?`<div class="subline">${sub}</div>`:''}`;
      wrap.appendChild(t);

      toastTimer=setTimeout(()=>{
        t.classList.add('fadeout');
        setTimeout(()=>t.remove(),230);
      }, duration);
    }

    /* âœ´ï¸ íŒŒí‹°í´ */
    function sparkleBurst(x,y,count=10,spread=120){
      const color=getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || DEFAULT_PRIMARY;
      for(let i=0;i<count;i++){
        const s=document.createElement('div');
        s.className='spark'; s.textContent='âœ´ï¸';
        s.style.left=`${x}px`; s.style.top=`${y}px`;
        const dx=(Math.random()*spread - spread/2).toFixed(0)+'px';
        const dy=(Math.random()*-spread - 30).toFixed(0)+'px';
        s.style.setProperty('--dx', dx);
        s.style.setProperty('--dy', dy);
        s.style.fontSize=(12 + Math.random()*9).toFixed(0)+'px';
        s.style.color=color;
        document.body.appendChild(s);
        setTimeout(()=>s.remove(),700);
      }
    }
    function sparkleAt(el,count=10){
      if(!el) return;
      const r=el.getBoundingClientRect();
      sparkleBurst(r.left + r.width*0.7, r.top + r.height*0.2, count, 120);
    }

    /* ì´ë¯¸ì§€ ë·°ì–´ */
    function openImageViewer(src){
      const v=document.getElementById('imgViewer');
      const img=document.getElementById('viewerImg');
      if(!v||!img) return;
      img.src=src;
      v.classList.add('open');
    }
    function closeImageViewer(){
      const v=document.getElementById('imgViewer');
      const img=document.getElementById('viewerImg');
      if(img) img.src='';
      if(v) v.classList.remove('open');
    }

    /* ë°±ì—… */
    function exportData(){
      const data = {
        memos, folders, lockPw,
        primary: localStorage.getItem('inspy_primary') || null,
        theme: localStorage.getItem('inspy_theme') || null
      };
      const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`inspyfold_backup_${new Date().toLocaleDateString()}.json`;
      a.click();
      toast('ë‚´ë³´ë‚´ê¸° ì¤€ë¹„ ì™„ë£Œ','ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë¼ìš”');
    }
    function importData(e){
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=(ev)=>{
        try{
          const data=JSON.parse(ev.target.result);
          memos=data.memos || [];
          folders=data.folders || ['ì•„ì´ë””ì–´','ì¼ìƒ'];
          lockPw=data.lockPw || null;

          if(data.primary && /^#[0-9A-Fa-f]{6}$/.test(data.primary)) localStorage.setItem('inspy_primary', data.primary);
          if(data.theme==='dark' || data.theme==='light') localStorage.setItem('inspy_theme', data.theme);

          if(lockPw) localStorage.setItem('inspy_pw', lockPw);
          else localStorage.removeItem('inspy_pw');

          save(false);
          toast('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ','ìƒˆ ë°ì´í„°ë¡œ ê°±ì‹ ëì–´ìš”');
          location.reload();
        }catch(err){
          toast('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨','íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ìš”');
        }
      };
      reader.readAsText(file);
    }

    /* ëª¨ë‹¬ */
    const modal={open:false, onSubmit:null};
    function modalOnBackdrop(e){ closeModal(); }

    function openModal(config){
      modal.open=true;
      modal.onSubmit = config.onSubmit || null;

      const backdrop=document.getElementById('modalBackdrop');
      const titleEl=document.getElementById('modalTitle');
      const descEl=document.getElementById('modalDesc');
      const hintEl=document.getElementById('modalHint');
      const inputEl=document.getElementById('modalInput');
      const actionsEl=document.getElementById('modalActions');
      const extraEl=document.getElementById('modalExtra');

      titleEl.innerText=config.title||'';
      descEl.innerText=config.desc||'';
      hintEl.innerText=config.hint||'';
      extraEl.innerHTML=config.extraHTML||'';

      if(config.showInput){
        inputEl.style.display='block';
        inputEl.type=config.inputType || 'text';
        inputEl.value=config.inputValue || '';
        inputEl.placeholder=config.inputPlaceholder || '';
        inputEl.maxLength=config.inputMax || 64;
        setTimeout(()=>inputEl.focus(),0);
      }else{
        inputEl.style.display='none';
        inputEl.value='';
      }

      actionsEl.innerHTML='';

      (config.actions||[]).forEach(a=>{
        const btn=document.createElement('button');
        btn.className=`btn-modal ${a.variant||''}`.trim();
        btn.innerText=a.label;
        btn.onclick=a.onClick;
        actionsEl.appendChild(btn);
      });

      inputEl.onkeydown=(ev)=>{
        if(ev.key==='Enter' && modal.onSubmit){
          ev.preventDefault();
          modal.onSubmit();
        }
      };

      backdrop.classList.remove('hidden');
    }
    function closeModal(){
      modal.open=false; modal.onSubmit=null;
      document.getElementById('modalBackdrop').classList.add('hidden');
      document.getElementById('modalExtra').innerHTML='';
    }
    function getModalInput(){ return document.getElementById('modalInput').value || ''; }
    function setModalHint(text){ document.getElementById('modalHint').innerText = text || ''; }

    /* íŒ”ë ˆíŠ¸ */
    function openPalette(){
      const presets=[
        '#d4a5a5','#f3a6b8','#ffb86b','#facc15','#34d399','#22c55e',
        '#2dd4bf','#38bdf8','#3b82f6','#8b5cf6','#a78bfa','#f472b6'
      ];
      const current = localStorage.getItem('inspy_primary') || DEFAULT_PRIMARY;
      const dots = presets.map(hex=>{
        const active=(hex.toLowerCase()===current.toLowerCase())?'active':'';
        return `<div class="color-dot ${active}" style="background:${hex}" onclick="setPrimary('${hex}')"></div>`;
      }).join('');

      openModal({
        title:'í…Œë§ˆ ìƒ‰ìƒ',
        desc:'ì•±ì˜ í¬ì¸íŠ¸ ì»¬ëŸ¬ë¥¼ ë°”ê¿”ìš”.',
        hint:'ì›í•˜ëŠ” ìƒ‰ì„ ì„ íƒí•œ ë’¤ ë‹«ì•„ë„ ìë™ ì €ì¥ë¼ìš”.',
        showInput:false,
        extraHTML:`<div class="palette-grid">${dots}</div>`,
        actions:[
          {label:'ê¸°ë³¸ê°’', onClick:()=>resetPrimary()},
          {label:'ì™„ë£Œ', variant:'primary', onClick:()=>{ toast('í…Œë§ˆ ì ìš© ì™„ë£Œ'); closeModal(); } }
        ]
      });
    }

    /* ì ê¸ˆ */
    const PW_REGEX=/^[A-Za-z0-9]+$/;

    function handleLockToggle(){
      if(!lockPw){
        openModal({
          title:'ì ê¸ˆ ì„¤ì •',
          desc:'ì´ ì•±ì„ ì ê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ìš”.',
          hint:'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸/ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.',
          showInput:true,
          inputType:'password',
          inputPlaceholder:'ì˜ë¬¸/ìˆ«ì ë¹„ë°€ë²ˆí˜¸',
          inputMax:32,
          actions:[
            {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
            {label:'ì ê·¸ê¸°', variant:'primary', onClick:()=>{
              const pw=getModalInput().trim();
              if(!pw){ setModalHint('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”.'); return; }
              if(!PW_REGEX.test(pw)){ setModalHint('ì˜ë¬¸/ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.'); return; }
              lockPw=pw;
              localStorage.setItem('inspy_pw', pw);
              unblurredIds=[];
              closeModal();
              setTimeout(()=>toast('ì ê¸ˆì´ ì„¤ì •ëì–´ìš”','ë©”ëª¨ëŠ” íƒ­í•˜ì—¬ ì¼ì‹œí•´ì œ ê°€ëŠ¥í•´ìš”'),60);
              render();
            }}
          ]
        });
        return;
      }

      /* âœ… ìš”ì²­: ì ê¸ˆ ë„ê¸° ëª¨ë‹¬ ë²„íŠ¼ 3ê°œë¥¼ "ë¶™ì—¬ì„œ ì˜¤ë¥¸ìª½ ì •ë ¬" */
      openModal({
        title:'ì ê¸ˆ ë„ê¸°',
        desc:'ì ê¸ˆì„ ë„ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”.',
        hint:'ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒì–´ë²„ë ¸ë‹¤ë©´ ì´ˆê¸°í™”ê°€ í•„ìš”í•´ìš”.',
        showInput:true,
        inputType:'password',
        inputPlaceholder:'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥',
        inputMax:32,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ì´ˆê¸°í™”', variant:'danger', onClick:()=>openResetModalStep1()},
          {label:'ì ê¸ˆ ë„ê¸°', variant:'primary', onClick:()=>{
            const pw=getModalInput();
            if(pw!==lockPw){ setModalHint('ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”.'); toast('ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”'); return; }
            lockPw=null;
            localStorage.removeItem('inspy_pw');
            unblurredIds=[];
            closeModal();
            setTimeout(()=>toast('ì ê¸ˆì„ ê»ì–´ìš”'),60);
            render();
          }}
        ]
      });
    }

    function openResetModalStep1(){
      openModal({
        title:'ì´ˆê¸°í™” ì•ˆë‚´',
        desc:'ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒì–´ë²„ë ¸ë‹¤ë©´ ì´ˆê¸°í™”ë§Œ ê°€ëŠ¥í•´ìš”.\nì´ˆê¸°í™”í•˜ë©´ ì ê¸ˆì´ í’€ë¦¬ë©´ì„œ, ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë¼ìš”.',
        hint:'ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í•œ ë²ˆ ë” í™•ì¸í•´ìš”.',
        showInput:false,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ë‹¤ìŒ', variant:'danger', onClick:()=>openResetModalStep2()}
        ]
      });
    }
    function openResetModalStep2(){
      openModal({
        title:'ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?',
        desc:'ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ë©´ ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë¼ìš”.\në˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.',
        hint:'ì‚­ì œë¥¼ ì›í•˜ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ìš”.',
        showInput:false,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ëª¨ë“  ê¸°ë¡ ì‚­ì œ', variant:'danger', onClick:()=>{
            localStorage.removeItem('inspy_memos');
            localStorage.removeItem('inspy_folders');
            localStorage.removeItem('inspy_pw');

            memos=[];
            folders=['ì•„ì´ë””ì–´','ì¼ìƒ'];
            lockPw=null;
            unblurredIds=[];

            closeModal();
            setTimeout(()=>toast('ì´ˆê¸°í™” ì™„ë£Œ','ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œëì–´ìš”'),60);
            location.reload();
          }}
        ]
      });
    }

    function unlockTemporarily(id){
      openModal({
        title:'ì¼ì‹œ í•´ì œ',
        desc:'ì´ ë©”ëª¨ë¥¼ ì¼ì‹œì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆì–´ìš”.',
        hint:'ì ê¸ˆì„ ì™„ì „íˆ ë„ë ¤ë©´ í—¤ë”ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ì„ ëˆŒëŸ¬ìš”.',
        showInput:true,
        inputType:'password',
        inputPlaceholder:'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥',
        inputMax:32,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ì¼ì‹œ í•´ì œ', variant:'primary', onClick:()=>{
            const pw=getModalInput();
            if(pw!==lockPw){ setModalHint('ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”.'); toast('ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”'); return; }
            if(!unblurredIds.includes(id)) unblurredIds.push(id);
            closeModal();
            setTimeout(()=>toast('ì¼ì‹œí•´ì œ ì™„ë£Œ','ì™„ì „ í•´ì œëŠ” í—¤ë” ìë¬¼ì‡ ì—ì„œ ê°€ëŠ¥í•´ìš”'),60);
            render();
          }}
        ]
      });
    }

    /* ê²€ìƒ‰ */
    function toggleSearch(){
      const sw=document.getElementById('searchWrap');
      sw.classList.toggle('open');
      if(sw.classList.contains('open')) document.getElementById('searchInput').focus();
      updateSearchClearBtn();
    }
    function handleSearchInput(){
      updateSearchClearBtn();
      render();
    }
    function updateSearchClearBtn(){
      const v=(document.getElementById('searchInput').value||'').trim();
      document.getElementById('searchClearBtn').classList.toggle('show', v.length>0);
    }
    function clearSearch(){
      const input=document.getElementById('searchInput');
      input.value='';
      updateSearchClearBtn();
      toast('ê²€ìƒ‰ì–´ ì‚­ì œë¨');
      render();
      input.focus();
    }

    /* ì €ì¥ */
    function save(doRender=true){
      localStorage.setItem('inspy_memos', JSON.stringify(memos));
      localStorage.setItem('inspy_folders', JSON.stringify(folders));
      if(doRender) render();
    }

    /* í´ë” */
    function addFolder(){
      openModal({
        title:'ìƒˆ í´ë” ë§Œë“¤ê¸°',
        desc:'í´ë” ì´ë¦„ì„ ì…ë ¥í•´ìš”.',
        hint:'ì¤‘ë³µ ì´ë¦„ì€ ë§Œë“¤ ìˆ˜ ì—†ì–´ìš”.',
        showInput:true,
        inputType:'text',
        inputPlaceholder:'ì˜ˆ: ì•„ì´ë””ì–´',
        inputMax:18,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ìƒì„±', variant:'primary', onClick:()=>{
            const n=getModalInput().trim();
            if(!n){ setModalHint('í´ë” ì´ë¦„ì„ ì…ë ¥í•´ìš”.'); return; }
            if(folders.includes(n)){ setModalHint('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë”ì˜ˆìš”.'); return; }
            folders.push(n);
            closeModal();
            setTimeout(()=>toast('í´ë” ìƒì„±ë¨', n),60);
            save();
          }}
        ]
      });
    }
    function deleteFolder(name, e){
      e.stopPropagation();
      if(folders.length<=1){ toast('í´ë”ëŠ” ìµœì†Œ 1ê°œê°€ í•„ìš”í•´ìš”'); return; }
      openModal({
        title:'í´ë” ì‚­ì œ',
        desc:`'${name}' í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”?`,
        hint:'í•´ë‹¹ í´ë”ì˜ ë©”ëª¨ëŠ” ë‹¤ë¥¸ í´ë”ë¡œ ì´ë™ë¼ìš”.',
        showInput:false,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ì‚­ì œ', variant:'danger', onClick:()=>{
            folders = folders.filter(f=>f!==name);
            memos = memos.map(m => m.tags[0]===name ? {...m, tags:[folders[0]]} : m);
            if(curFolder===name) curFolder='ì „ì²´';
            closeModal();
            setTimeout(()=>toast('í´ë” ì‚­ì œë¨', `'${name}'`),60);
            save();
          }}
        ]
      });
    }
    function changeFolder(n){ curFolder=n; render(); }

    /* ë©”ëª¨ ì‚­ì œ */
    function confirmDeleteMemo(id){
      openModal({
        title:'ë©”ëª¨ ì‚­ì œ',
        desc:'ì´ ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?',
        hint:'ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.',
        showInput:false,
        actions:[
          {label:'ì·¨ì†Œ', onClick:()=>closeModal()},
          {label:'ì‚­ì œ', variant:'danger', onClick:()=>{
            closeModal();
            deleteMemoById(id);
          }}
        ]
      });
    }
    function deleteMemoById(id){
      const item=document.querySelector(`.memo-item[data-id="${id}"]`);
      if(item) item.classList.add('removing');
      setTimeout(()=>{
        memos = memos.filter(v=>v.id!==id);
        unblurredIds = unblurredIds.filter(x=>x!==id);
        toast('ì‚­ì œ ì™„ë£Œ');
        save();
      }, 360);
    }

    /* âœ… ì¦ê²¨ì°¾ê¸° ë™ì‘ ë³´ì¥ + í…Œë§ˆìƒ‰(ìƒ‰ì€ CSS varë¡œ ì´ë¯¸ ë”°ë¼ê°) */
    function toggleFav(id, el){
      memos = memos.map(v => v.id === id ? ({...v, fav: !v.fav}) : v);

      if(el){
        el.classList.remove('popped');
        void el.offsetWidth;
        el.classList.add('popped');
      }

      localStorage.setItem('inspy_memos', JSON.stringify(memos));
      setTimeout(()=>render(), 120);
    }

    function updateMemoTag(id, newTag){
      memos = memos.map(m => m.id===id ? ({...m, tags:[newTag]}) : m);
      save();
    }

    /* ì²¨ë¶€ ì´ˆê¸°í™” */
    function clearAttachedImage(silent=true){
      attachedImage="";
      attachedImageMeta={w:0,h:0,kb:0};
      const input=document.getElementById('imgInput'); if(input) input.value="";
      const wrap=document.getElementById('imgPreviewWrap');
      const img=document.getElementById('imgPreview');
      if(wrap) wrap.style.display='none';
      if(img) img.src='';
      if(!silent) toast('ì²¨ë¶€ í•´ì œë¨');
    }

    /* ì´ë¯¸ì§€ ì••ì¶• */
    async function compressImageFile(file, opts={}){
      const maxW=opts.maxW ?? 1440;
      const maxH=opts.maxH ?? 1440;
      const quality=opts.quality ?? 0.82;

      const img=new Image();
      const url=URL.createObjectURL(file);

      await new Promise((res,rej)=>{
        img.onload=()=>res();
        img.onerror=()=>rej(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
        img.src=url;
      });

      const srcW=img.naturalWidth || img.width;
      const srcH=img.naturalHeight || img.height;

      const scale=Math.min(maxW/srcW, maxH/srcH, 1);
      const dstW=Math.max(1, Math.round(srcW*scale));
      const dstH=Math.max(1, Math.round(srcH*scale));

      const canvas=document.createElement('canvas');
      canvas.width=dstW; canvas.height=dstH;
      const ctx=canvas.getContext('2d', {alpha:false});
      ctx.fillStyle='#ffffff';
      ctx.fillRect(0,0,dstW,dstH);
      ctx.imageSmoothingEnabled=true;
      ctx.imageSmoothingQuality='high';
      ctx.drawImage(img,0,0,dstW,dstH);

      const dataUrl=canvas.toDataURL('image/jpeg', quality);
      URL.revokeObjectURL(url);

      const kb=Math.round((dataUrl.length*3)/4/1024);
      return {dataUrl, w:dstW, h:dstH, kb};
    }

    let previewPressTimer=null;
    function bindPreviewInteractions(){
      const img=document.getElementById('imgPreview');
      if(!img) return;
      img.onclick=()=>{ if(attachedImage) openImageViewer(attachedImage); };
      img.onpointerdown=()=>{
        if(!attachedImage) return;
        clearTimeout(previewPressTimer);
        previewPressTimer=setTimeout(()=>openImageViewer(attachedImage), 320);
      };
      img.onpointerup=()=>clearTimeout(previewPressTimer);
      img.onpointercancel=()=>clearTimeout(previewPressTimer);
      img.onpointerleave=()=>clearTimeout(previewPressTimer);
    }

    async function previewImage(e){
      const file=e.target.files && e.target.files[0];
      if(!file) return;
      if(!file.type.startsWith('image/')){ toast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆì–´ìš”'); return; }

      toast('ì²˜ë¦¬ ì¤‘...','ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶•í•˜ê³  ìˆì–´ìš”', 900);

      try{
        const {dataUrl,w,h,kb} = await compressImageFile(file, {maxW:1440, maxH:1440, quality:0.82});
        attachedImage=dataUrl;
        attachedImageMeta={w,h,kb};

        const wrap=document.getElementById('imgPreviewWrap');
        const img=document.getElementById('imgPreview');
        if(img) img.src=attachedImage;
        if(wrap) wrap.style.display='block';
        bindPreviewInteractions();

        toast('ì´ë¯¸ì§€ ì²¨ë¶€ë¨', `${w}Ã—${h}px Â· ì•½ ${kb}KB`);
      }catch(err){
        toast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨','ë‹¤ì‹œ ì‹œë„í•´ìš”');
        clearAttachedImage(true);
      }
    }

    /* ë©”ëª¨ ì¶”ê°€ */
    function addMemo(){
      const t=document.getElementById('memoInput').value.trim();
      if(!t && !attachedImage) return;

      const n=new Date();
      const dStr=`${n.getFullYear()}. ${n.getMonth()+1}. ${n.getDate()}.`;
      const tStr=n.toLocaleTimeString('ko-KR',{hour:'2-digit', minute:'2-digit'});

      memos.push({
        id:Date.now(),
        text:t,
        img:attachedImage,
        tags:[document.getElementById('folderSelect').value],
        date:dStr, time:tStr,
        fav:false
      });

      const btn=document.getElementById('saveBtn');
      if(btn){
        btn.classList.add('saving');
        setTimeout(()=>btn.classList.remove('saving'),180);
        btn.classList.add('saved');
        setTimeout(()=>btn.classList.remove('saved'),220);
        sparkleAt(btn, 11);
      }

      document.getElementById('memoInput').value='';
      clearAttachedImage(true);

      selectedRange={start:dStr, end:dStr};
      rangeMode='idle';
      rangeAnchor=null;

      toast('ì €ì¥ëì–´ìš” âœ´ï¸');
      save();
    }

    /* ìº˜ë¦°ë” ë Œë” */
    function renderCalendar(){
      const container=document.getElementById('calGridContainer');
      container.innerHTML='';
      const grid=document.createElement('div');
      grid.className='cal-grid';

      const year=currentViewDate.getFullYear();
      const month=currentViewDate.getMonth();
      document.getElementById('calMonth').innerText = `${year}ë…„ ${month+1}ì›”`;

      ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((t,idx)=>{
        const l=document.createElement('div');
        l.className='cal-dow' + (idx===0?' sun':(idx===6?' sat':''));
        l.innerText=t;
        grid.appendChild(l);
      });

      const firstDay=new Date(year,month,1).getDay();
      const lastDate=new Date(year,month+1,0).getDate();
      for(let i=0;i<firstDay;i++) grid.appendChild(document.createElement('div'));

      const activeRange = selectedRange ? normalizeRange(selectedRange.start, selectedRange.end) : null;

      function getCellDateStrFromEl(el){
        const ds = el?.dataset?.dateStr;
        return ds || null;
      }
      function onDayTap(dateStr){
        if(!selectedRange){
          selectedRange={start:dateStr, end:dateStr};
          rangeMode='awaitEnd';
          rangeAnchor=dateStr;
          toast('ì‹œì‘ì¼ ì„ íƒë¨','ë‹¤ë¥¸ ë‹¬ë¡œ ì´ë™í•´ì„œ ì¢…ë£Œì¼ì„ ì„ íƒí•´ìš”');
          render();
          return;
        }
        if(rangeMode==='awaitEnd' && rangeAnchor){
          selectedRange = normalizeRange(rangeAnchor, dateStr);
          rangeMode='idle';
          rangeAnchor=null;
          toast('ë²”ìœ„ ì„ íƒ ì™„ë£Œ');
          render();
          return;
        }
        selectedRange={start:dateStr, end:dateStr};
        rangeMode='awaitEnd';
        rangeAnchor=dateStr;
        toast('ì‹œì‘ì¼ ì„ íƒë¨','ì¢…ë£Œì¼ì„ ì„ íƒí•´ìš” (ë‹¤ë¥¸ ë‹¬ ê°€ëŠ¥)');
        render();
      }

      for(let d=1; d<=lastDate; d++){
        const fullDate = `${year}. ${month+1}. ${d}.`;
        const dayDiv=document.createElement('div');
        dayDiv.className='cal-day';
        dayDiv.innerText=d;
        dayDiv.dataset.dateStr=fullDate;

        const dow=new Date(year,month,d).getDay();
        if(dow===0) dayDiv.classList.add('sun');
        if(dow===6) dayDiv.classList.add('sat');

        if(memos.some(m=>m.date===fullDate)) dayDiv.classList.add('has-memo');

        if(activeRange){
          if(isInRange(fullDate, activeRange)) dayDiv.classList.add('in-range');
          if(fullDate===activeRange.start) dayDiv.classList.add('range-start');
          if(fullDate===activeRange.end) dayDiv.classList.add('range-end');
        }

        dayDiv.addEventListener('pointerdown',(e)=>{
          e.preventDefault();
          dayDiv.setPointerCapture(e.pointerId);
          dragActive=true;

          if(rangeMode!=='awaitEnd'){
            selectedRange={start:fullDate, end:fullDate};
            rangeMode='awaitEnd';
            rangeAnchor=fullDate;
            render();
            toast('ì‹œì‘ì¼ ì„ íƒë¨','ë“œë˜ê·¸ë¡œ ì¡°ì ˆí•˜ê±°ë‚˜, ë‹¤ë¥¸ ë‹¬ë¡œ ì´ë™í•´ ì¢…ë£Œì¼ì„ íƒ­í•´ìš”');
            return;
          }
        });
        dayDiv.addEventListener('pointermove',(e)=>{
          if(!dragActive) return;
          if(rangeMode!=='awaitEnd' || !rangeAnchor) return;
          const el=document.elementFromPoint(e.clientX, e.clientY);
          const dateStr=getCellDateStrFromEl(el?.closest?.('.cal-day'));
          if(!dateStr) return;
          selectedRange = normalizeRange(rangeAnchor, dateStr);
          render();
        });
        dayDiv.addEventListener('pointerup',(e)=>{
          e.preventDefault();
          dragActive=false;
        });
        dayDiv.addEventListener('pointercancel',()=>{ dragActive=false; });
        dayDiv.addEventListener('click',()=>{ if(dragActive) return; onDayTap(fullDate); });

        grid.appendChild(dayDiv);
      }

      container.appendChild(grid);
    }

    function changeMonth(v){
      currentViewDate.setMonth(currentViewDate.getMonth()+v);
      renderCalendar();
    }

    function clearRangeSelection(){
      selectedRange=null;
      rangeMode='idle';
      rangeAnchor=null;
      toast('ì „ì²´ë³´ê¸°');
      render();
    }

    function filterDate(d){
      if(!d){ clearRangeSelection(); return; }
      selectedRange={start:d, end:d};
      rangeMode='idle';
      rangeAnchor=null;
      render();
    }

    function setFavFilter(v){
      isFavFilter=v;
      document.getElementById('tabAll').classList.toggle('active', !v);
      document.getElementById('tabFav').classList.toggle('active', v);
      render();
    }

    function renderRangeText(){
      const wrap=document.getElementById('rangeTextWrap');
      if(!wrap) return;

      if(!selectedRange){
        wrap.style.display='none';
        wrap.innerHTML='';
        return;
      }
      const r=normalizeRange(selectedRange.start, selectedRange.end);
      if(!r){
        wrap.style.display='none';
        wrap.innerHTML='';
        return;
      }
      wrap.style.display='block';
      wrap.innerHTML = `
        <div class="range-line">
          ${rangeMode==='awaitEnd' ? 'ì¢…ë£Œì¼ ì„ íƒ ì¤‘ Â· ' : ''}${fmtCompact(r.start)} ~ ${fmtCompact(r.end)}
          <button class="range-chip-btn" onclick="clearRangeSelection()" title="ë²”ìœ„ í•´ì œ">âœ•</button>
        </div>
      `;
    }

    function render(){
      document.getElementById('lockBtn').innerText = lockPw ? 'ğŸ”’' : 'ğŸ”“';
      renderCalendar();
      renderRangeText();
      updateSearchClearBtn();

      const keyword=(document.getElementById('searchInput').value||'').toLowerCase();
      const rangeNorm = selectedRange ? normalizeRange(selectedRange.start, selectedRange.end) : null;
      const dateFilteredMemos = rangeNorm ? memos.filter(m=>isInRange(m.date, rangeNorm)) : memos;

      document.getElementById('allCount').innerText = dateFilteredMemos.length;
      document.getElementById('favCount').innerText = dateFilteredMemos.filter(m=>m.fav).length;
      document.getElementById('sparkDayCount').innerText = [...new Set(memos.map(m=>m.date))].length;

      const fList=document.getElementById('folderList');
      const fSelect=document.getElementById('folderSelect');

      fList.innerHTML = `<div class="folder-chip" onclick="toggleSearch()">ğŸ”</div>`;
      fList.innerHTML += `<div class="folder-chip ${curFolder==='ì „ì²´'?'active':''}" onclick="changeFolder('ì „ì²´')">ì „ì²´</div>`;
      fSelect.innerHTML='';

      folders.forEach(f=>{
        fList.innerHTML += `<div class="folder-chip ${curFolder===f?'active':''}" onclick="changeFolder('${f}')">${f} <span class="btn-del-folder" onclick="deleteFolder('${f}', event)">Ã—</span></div>`;
        fSelect.innerHTML += `<option value="${f}" ${curFolder===f?'selected':''}>${f}</option>`;
      });
      fList.innerHTML += `<div class="folder-chip" onclick="addFolder()">+</div>`;

      const container=document.getElementById('memoContainer');
      container.innerHTML='';

      let filtered = dateFilteredMemos.filter(m =>
        (curFolder==='ì „ì²´' || m.tags.includes(curFolder)) &&
        (!isFavFilter || m.fav) &&
        ((m.text||'').toLowerCase().includes(keyword))
      ).reverse();

      filtered.forEach((m)=>{
        const isBlurred = !!lockPw && !unblurredIds.includes(m.id);

        const item=document.createElement('div');
        item.className='memo-item';
        item.dataset.id=m.id;

        item.innerHTML = `
          ${isBlurred ? `<div class="lock-overlay" onclick="unlockTemporarily(${m.id})"><span>ğŸ”’ ì ê¸´ ì˜ê° (íƒ­í•˜ì—¬ ì¼ì‹œí•´ì œ)</span></div>` : ''}
          <div class="${isBlurred ? 'locked-content' : ''}">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <select class="memo-folder-select" onchange="updateMemoTag(${m.id}, this.value)">
                ${folders.map(f => `<option value="${f}" ${m.tags[0]===f?'selected':''}>${f}</option>`).join('')}
              </select>

              <span class="star-btn"
                    onpointerdown="event.stopPropagation()"
                    onclick="toggleFav(${m.id}, this); event.stopPropagation();">
                ${m.fav ? 'â­' : 'â˜†'}
              </span>
            </div>

            ${m.img ? `<img src="${m.img}" style="width:100%; border-radius:15px; margin-top:15px; border:1px solid var(--border);"
                        onclick="openImageViewer('${m.img}')" />` : ''}

            <div style="font-size:17px; line-height:1.8; margin-top:15px; font-weight:850;">
              ${(m.text||'').replace(/\n/g,'<br>')}
            </div>

            <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:12px; color:var(--sub-text); border-top:1px solid var(--border); padding-top:15px; font-weight:850;">
              <span>${m.date} ${m.time}</span>
              <span onclick="confirmDeleteMemo(${m.id})"
                    style="color:#ff5f5f;cursor:pointer;font-weight:950;-webkit-tap-highlight-color: transparent;">
                ì‚­ì œ
              </span>
            </div>
          </div>
        `;
        container.appendChild(item);
      });
    }

    /* í…Œë§ˆ í† ê¸€: ìœ ì €ê°€ ë°”ê¿¨ìœ¼ë©´ ì €ì¥ */
    async function toggleTheme(fromUser=false){
      const isDark=document.body.classList.contains('dark-mode');
      const nextDark=!isDark;

      document.body.classList.toggle('dark-mode', nextDark);
      document.getElementById('themeBtn').innerText = nextDark ? 'â˜€ï¸' : 'ğŸŒ™';
      document.getElementById('mainLogo').src = base + (nextDark ? 'logo_d.png' : 'logo_l.png');

      if(fromUser) localStorage.setItem('inspy_theme', nextDark ? 'dark' : 'light');
      toast(nextDark ? 'ë‹¤í¬ ëª¨ë“œ' : 'ë¼ì´íŠ¸ ëª¨ë“œ');
    }

    // ì´ˆê¸°í™”
    applyInitialTheme();
    loadPrimary();
    render();
    clearAttachedImage(true);
  </script>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
